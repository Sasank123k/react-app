// File: src/test/java/com/wellsfargo/utcap/service/DagSqlServiceTest.java
package com.wellsfargo.utcap.service;

import com.wellsfargo.utcap.exception.ResourceNotFoundException;
import com.wellsfargo.utcap.model.DagSql;
import com.wellsfargo.utcap.model.HiveTable;
import com.wellsfargo.utcap.model.JiraStoryIntake;
import com.wellsfargo.utcap.model.SqlDatatype;
import com.wellsfargo.utcap.repository.DagSqlRepository;
import com.wellsfargo.utcap.repository.HiveTableRepository;
import com.wellsfargo.utcap.repository.JiraStoryIntakeRepository;
import com.wellsfargo.utcap.repository.SqlDatatypeRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
public class DagSqlServiceTest {

    @Mock
    private DagSqlRepository dagSqlRepository;

    @Mock
    private JiraStoryIntakeRepository jiraStoryIntakeRepository;

    @Mock
    private HiveTableRepository hiveTableRepository;

    @Mock
    private SqlDatatypeRepository sqlDatatypeRepository;

    @InjectMocks
    private DagSqlService dagSqlService;

    private final String requirementId = "req123";

    @Test
    void testGetDagSql_existingRecord() throws Exception {
        DagSql existing = new DagSql();
        existing.setRequirementId(requirementId);

        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.of(existing));

        DagSql result = dagSqlService.getDagSql(requirementId);

        assertSame(existing, result);
        verify(dagSqlRepository, times(1)).findByRequirementId(requirementId);
        verifyNoMoreInteractions(dagSqlRepository);
    }

    @Test
    void testGetDagSql_generateNewRecord() throws Exception {
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.empty());

        JiraStoryIntake jiraStory = new JiraStoryIntake();
        jiraStory.setSourceSchema("srcSchema");
        jiraStory.setSourceTableName("srcTable");
        jiraStory.setTargetSchema("tgtSchema");
        jiraStory.setApplicationName("App");
        jiraStory.setTargetTableName("Tbl");
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.of(jiraStory));

        HiveTable hiveTable = new HiveTable();
        hiveTable.setFileSetAttr("col1|string|#col2|decimal(10,2)");
        when(hiveTableRepository.findByTableName("srcSchema.srcTable"))
            .thenReturn(Collections.singletonList(hiveTable));

        Map<String, String> mapping = Map.of("STRING", "STRING", "DECIMAL", "NUMERIC");
        when(sqlDatatypeRepository.findById("defaultMapping"))
            .thenReturn(Optional.of(new SqlDatatype("defaultMapping", mapping)));

        when(dagSqlRepository.save(any(DagSql.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

        DagSql generated = dagSqlService.getDagSql(requirementId);

        assertEquals(requirementId, generated.getRequirementId());
        assertTrue(generated.getCreateSqlContent()
            .contains("CREATE TABLE tgtSchema.AppTbl"));
        assertTrue(generated.getDeleteSqlContent()
            .contains("DROP TABLE tgtSchema.AppTbl"));

        verify(dagSqlRepository).save(generated);
    }

    @Test
    void testGetDagSql_missingJiraStory() {
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.empty());
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.empty());

        RuntimeException ex = assertThrows(RuntimeException.class, () ->
            dagSqlService.getDagSql(requirementId)
        );
        assertTrue(ex.getCause() instanceof ResourceNotFoundException);
    }

    @Test
    void testGenerateAndSaveDagSql_invalidFileSetAttr() {
        JiraStoryIntake jiraStory = new JiraStoryIntake();
        jiraStory.setSourceSchema("srcSchema");
        jiraStory.setSourceTableName("srcTable");
        jiraStory.setTargetSchema("tgtSchema");
        jiraStory.setApplicationName("App");
        jiraStory.setTargetTableName("Tbl");
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.of(jiraStory));

        HiveTable hiveTable = new HiveTable();
        hiveTable.setFileSetAttr("col1|string|#col2"); // odd tokens
        when(hiveTableRepository.findByTableName("srcSchema.srcTable"))
            .thenReturn(Collections.singletonList(hiveTable));

        IllegalArgumentException ex = assertThrows(IllegalArgumentException.class, () ->
            dagSqlService.generateAndSaveDagSql(requirementId)
        );
        assertTrue(ex.getMessage().contains("Invalid fileSetAttr format"));
    }

    @Test
    void testGenerateAndSaveDagSql_missingJiraStory() {
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.empty());

        ResourceNotFoundException ex = assertThrows(ResourceNotFoundException.class, () ->
            dagSqlService.generateAndSaveDagSql(requirementId)
        );
        assertTrue(ex.getMessage().contains("JiraStoryIntake not found"));
    }

    @Test
    void testUpdateDagSql_success() throws Exception {
        DagSql existing = new DagSql();
        existing.setRequirementId(requirementId);
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.of(existing));
        when(dagSqlRepository.save(existing))
            .thenReturn(existing);

        DagSql result = dagSqlService.updateDagSql(requirementId, "newCreate", "newDelete");

        assertEquals("newCreate", result.getCreateSqlContent());
        assertEquals("newDelete", result.getDeleteSqlContent());
        verify(dagSqlRepository).save(existing);
    }

    @Test
    void testUpdateDagSql_missingRecord() {
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.empty());

        ResourceNotFoundException ex = assertThrows(ResourceNotFoundException.class, () ->
            dagSqlService.updateDagSql(requirementId, "c", "d")
        );
        assertTrue(ex.getMessage().contains("DagSql not found"));
    }
}
