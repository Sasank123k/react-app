import React, { useEffect, useState } from 'react';
import NavigationBar from '../../../components/NavigationBar/NavigationBar';
import { MICROSERVICE_URL } from '../../../util/constants';
import { useAppGlobalState } from 'gwf/react-library';
import { generateSearHeader } from '../../../Authentication';
import axios from 'axios';

import {
  FlexGrid,
  FlexGridItem,
  MenuItem,
  Select,
  Button,
  TextInput,
  TextArea,
  Section,
  MessageBox,
  IconInformationalLight,
  IconWarning,
  Form,
} from '@pioneer/core';

const UsecaseOnboarding = () => {
  const appGlobalState = useAppGlobalState();

  const [l4option, setL4option] = useState('');
  const [l4optionslist, setL4optionslist] = useState([]);

  const [l3option, setL3option] = useState('');
  const [l3optionslist, setL3optionslist] = useState([]);

  const [l2option, setL2option] = useState('');
  const [l2optionslist, setL2optionslist] = useState([]);

  const [usecaseName, setUsecaseName] = useState('');
  const [usecaseDescription, setUsecaseDescription] = useState('');

  const [adsList, setAdsList] = useState([]);
  const [selectedADS, setSelectedADS] = useState('');
  const [selectedAdsAlias, setSelectedAdsAlias] = useState('');

  const [formData, setFormData] = useState({
    l2BusinessOwner: '',
    l2TechOwner: '',
    l3BusinessOwner: '',
    l3TechOwner: '',
    l4BusinessOwner: '',
    l4TechOwner: '',
    l1: '',
    l1ProductOwner: '',
    ADS: '',
    adsAlias: ''
  });
  const [messages, setMessages] = useState('');
  const [messageBoxState, setMessageBoxState] = React.useState({
    isMessageOpen: false,
    messageType: 'Information',
  });

  const fetchL4ListData = async () => {
    try {
      const config = {
        method: 'GET',
        url: `${MICROSERVICE_URL}/usecaseonboarding/getL4List`,
        headers: generateSearHeader(appGlobalState),
      };

      const response = await axios(config);
      console.log('L4 list data is', response.data);
      setL4optionslist(response.data);
    } catch (error) {
      console.error('Error fetching data', error);
    }
  };

  const fetchL3ListData = async (l4option) => {
    console.log('Before api call value of l4option is ', l4option);
    try {
      const config = {
        method: 'GET',
        url: `${MICROSERVICE_URL}/usecaseonboarding/getL3ForL4`,
        params: { l4: l4option },
        headers: generateSearHeader(appGlobalState),
      };

      const response = await axios(config);
      console.log('L3 list data is', response.data);
      setL3optionslist(response.data);
    } catch (error) {
      console.error('Error fetching data', error);
    }
  };

  const fetchL2ListData = async (l3option) => {
    console.log('L3 option selected by user before api call is ', l3option);
    try {
      const config = {
        method: 'GET',
        url: `${MICROSERVICE_URL}/usecaseonboarding/getL2ForL3`,
        params: { l3: l3option },
        headers: generateSearHeader(appGlobalState),
      };

      const response = await axios(config);
      console.log('L2 list data is', response.data);
      setL2optionslist(response.data);
    } catch (error) {
      console.error('Error fetching data', error);
    }
  };

  const fetchADSList = async () => {
    try {
      const config = {
        method: 'GET',
        url: `${MICROSERVICE_URL}/usecaseonboarding/getADSList`,
        headers: generateSearHeader(appGlobalState),
      };

      const response = await axios(config);
      console.log('ADSLIST', response.data);
      setAdsList(response.data);
    } catch (error) {
      console.error('Error fetching ADS list');
    }
  };

  const fetchBusinessOwnersAndTechOwners = async (
    l4option,
    l3option,
    l2option
  ) => {
    console.log(
      'Selected values before api call of business and tech owners is ',
      l4option,
      l3option,
      l2option
    );
    try {
      const config = {
        method: 'GET',
        url: `${MICROSERVICE_URL}/usecaseonboarding/getFieldByL4L3L2`,
        params: { l4: l4option, l3: l3option, l2: l2option },
        headers: generateSearHeader(appGlobalState),
      };

      const response = await axios(config);
      console.log('Business owners and tech owners api', response.data);
      setFormData(response.data);
    } catch (error) {
      console.error('Error fetching data', error);
      setFormData({
        l2BusinessOwner: '',
        l2TechOwner: '',
        l3BusinessOwner: '',
        l3TechOwner: '',
        l4BusinessOwner: '',
        l4TechOwner: '',
      });
    }
  };

  const handleSubmit = async () => {
    try {
      const dataToSubmit = {
        ...formData,
        usecaseName: usecaseName,
        usecaseDescription: usecaseDescription,
        l4: l4option,
        l3: l3option,
        l2: l2option,
        ADS: selectedADS,
        adsAlias: selectedAdsAlias,
      };

      const config = {
        method: 'POST',
        url: `${MICROSERVICE_URL}/usecaseonboarding/saveUsecaseData`,
        headers: generateSearHeader(appGlobalState),
        data: dataToSubmit,
      };

      const response = await axios(config);
      console.log('Data saved successfully', response.data);
      showMessages('Data Saved Successfully!');
    } catch (error) {
      console.error('Error saving data', error);
    }
  };

  const handleL4Update = (e) => {
    setL4option(e.value);
  };
  const handleL3Update = (e) => {
    setL3option(e.value);
  };
  const handleL2Update = (e) => {
    setL2option(e.value);
  };

  const handleADSUpdate = (selectedValue) => {
    console.log('Selected value is', selectedValue);
    setSelectedADS(selectedValue.value);

    const selectedItem = adsList.find(
      (item) => Object.keys(item)[0] === selectedValue.value
    );
    console.log('ads list is ', adsList);
    console.log('selected item is ', selectedItem);
    if (selectedItem) {
      const key = selectedValue.value;
      const aliasValue = selectedItem[key];
      console.log('alias is ', aliasValue);
      setSelectedAdsAlias(aliasValue);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e;
    setFormData({
      ...formData,
      [name]: value,
    });
  };
  const handleUsecase = (e) => {
    setUsecaseName(e.value);
  };
  const handleUsecaseDescription = (e) => {
    setUsecaseDescription(e.value);
  };

  const handleClose = () => {
    setTimeout(() => {
      setMessageBoxState({ ...messageBoxState, isMessageOpen: false });
    }, 0);
  };

  const showShowMessageBar = (message, type = 'information') => {
    console.log('testing message bar: ', message);
    setMessages(message);
    setMessageBoxState({
      isMessageOpen: true,
      messageType: type,
    });
    setTimeout(
      () => {
        setMessageBoxState({
          ...messageBoxState,
          isMessageOpen: false,
          messageType: type,
        });
      },
      5000
    );
  };

  useEffect(() => {
    fetchL4ListData();
    fetchADSList();
  }, []);

  useEffect(() => {
    if (l4option.length > 0) {
      fetchL3ListData(l4option);
    }
  }, [l4option]);

  useEffect(() => {
    if (l3option.length > 0) {
      fetchL2ListData(l3option);
    }
  }, [l3option]);

  //when all 3 are selected, autofill the 3 business owners and 3 tech owners
  useEffect(() => {
    if (l3option.length > 0 && l4option.length > 0 && l2option.length > 0) {
      fetchBusinessOwnersAndTechOwners(l4option, l3option, l2option);
    }
  }, [l4option, l3option, l2option]);

  return (
    <>
      <NavigationBar />
      <MessageBox
        open={messageBoxState.isMessageOpen}
        theme={messageBoxState.messageType}
        icon={
          messageBoxState.messageType === 'warning' ? (
            <IconWarning size="small" />
          ) : (
            <IconInformationalLight size="small" />
          )
        }
        onClose={handleClose}
        zIndex={9999}
        closeButton
      >
        <h4 style={{ color: 'black' }}>{messages}</h4>
      </MessageBox>
      <div className="usecaseonboarding" style={{ marginLeft: '20px' }}>
        <div style={{ textAlign: 'center' }}>
          <h1 style={{ fontSize: '24px', fontWeight: 'bold' }}>
            Usecase Onboarding{' '}
          </h1>
        </div>
        <Form onSubmit={handleSubmit} style={{ marginRight: '15px' }}>
          <FlexGrid>
            <FlexGridItem span={4}>
              <Select
                label="Select L4"
                name="l4"
                required={true}
                onValueChange={handleL4Update}
              >
                {l4optionslist.map((option) => (
                  <MenuItem key={option} value={option}>
                    {option}
                  </MenuItem>
                ))}
              </Select>
            </FlexGridItem>

            <FlexGridItem span={4}>
              <Select
                label="Select L3"
                required={true}
                name="l3"
                onValueChange={handleL3Update}
              >
                {l3optionslist.map((option) => (
                  <MenuItem key={option} value={option}>
                    {option}
                  </MenuItem>
                ))}
              </Select>
            </FlexGridItem>

            <FlexGridItem span={4}>
              <Select
                label="Select L2"
                required={true}
                name="l2"
                onValueChange={handleL2Update}
              >
                {l2optionslist.map((option) => (
                  <MenuItem key={option} value={option}>
                    {option}
                  </MenuItem>
                ))}
              </Select>
            </FlexGridItem>
          </FlexGrid>
          <br />

          <Section title="Business Owners" defaultExpanded="true">
            <FlexGrid>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required={true}
                  key={`input-${formData.l4BusinessOwner || 'unresolved'}`}
                  label="L4 Business Owner Name"
                  value={formData.l4BusinessOwner}
                  name="l4BusinessOwner"
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  key={`input-${formData.l3BusinessOwner || 'unresolved'}`}
                  label="L3 Business Owner Name"
                  name="l3BusinessOwner"
                  value={formData.l3BusinessOwner}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L2 Business Owner Name"
                  name="l2BusinessOwner"
                  value={formData.l2BusinessOwner}
                  key={`input-${formData.l2BusinessOwner || 'unresolved'}`}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
            </FlexGrid>
          </Section>
          <br />

          {/* TECH OWNERS */}
          <Section title="Tech Owners" defaultExpanded="true">
            <FlexGrid>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L4 Tech Owner Name"
                  name="l4TechOwner"
                  value={formData.l4TechOwner}
                  key={`input-${formData.l4TechOwner || 'unresolved'}`}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L3 Tech Owner Name"
                  value={formData.l3TechOwner}
                  key={`input-${formData.l3TechOwner || 'unresolved'}`}
                  name="l3TechOwner"
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L2 Tech Owner Name"
                  name="l2TechOwner"
                  value={formData.l2TechOwner}
                  key={`input-${formData.l2TechOwner || 'unresolved'}`}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
            </FlexGrid>
          </Section>

          <br />
          <Section title="L1 & ADS" defaultExpanded="true">
            <FlexGrid>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L1"
                  name="l1"
                  value={formData.l1}
                  key={`input-${formData.l1 || 'unresolved'}`}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="L1 Product Owner"
                  name="l1ProductOwner"
                  value={formData.l1ProductOwner}
                  key={`input-${formData.l1ProductOwner || 'unresolved'}`}
                  onValueChange={(e) => handleInputChange(e)}
                  style={{
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <Select
                  label="Select ADS"
                  name="ads"
                  onValueChange={handleADSUpdate}
                  required={true}
                >
                  {adsList.map((item) => {
                    const key = Object.keys(item)[0];
                    return (
                      <MenuItem key={key} value={key}>
                        {key}
                      </MenuItem>
                    );
                  })}
                </Select>
              </FlexGridItem>
            </FlexGrid>
          </Section>
          <br />
          <Section title="Usecase Details" defaultExpanded="true">
            <FlexGrid>
              <FlexGridItem span={4}>
                <TextInput
                  type="text"
                  required="true"
                  label="Usecase Name"
                  name="usecaseName"
                  onValueChange={(e) => {
                    handleUsecase(e);
                  }}
                  style={{
                    width: '100%',
                    border: '1px solid #ccc',
                    borderRadius: '4px',
                    padding: '10px',
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
              <FlexGridItem span={4}>
                <TextArea
                  type="text"
                  required="true"
                  label="Usecase Description"
                  name="usecaseDescription"
                  onValueChange={(e) => handleUsecaseDescription(e)}
                  style={{
                    width: '100%',
                    marginBottom: '5px',
                    padding: '5px',
                    borderRadius: '4px',
                    border: '1px solid #ccc',
                    fontSize: '1rem',
                    outline: 'none',
                  }}
                />
              </FlexGridItem>
            </FlexGrid>
          </Section>
          <FlexGrid alignVertical="center" alignHorizontal="center">
            <FlexGridItem>
              <Button label="Submit" type="submit" />
            </FlexGridItem>
          </FlexGrid>
        </Form>
      </div>
    </>
  );
};

export default UsecaseOnboarding;
