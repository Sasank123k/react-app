package com.wellsfargo.utcap.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.wellsfargo.utcap.repository.BuildRequestRepository;
import com.wellsfargo.utcap.config.JenkinsProperties;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Assertions;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;
import org.junit.jupiter.api.extension.ExtendWith;

/**
 * Phase 1 & 2:
 * - Phase 1: Basic setup with dependency injection and field initialization.
 * - Phase 2: Testing the helper methods:
 *   - helperStageStatus(JsonNode, String)
 *   - helperDeployStatus(JsonNode, String)
 *   - validate(JsonNode)
 */
@ExtendWith(MockitoExtension.class)
public class JenkinsClientTest {

    @Mock
    private BuildRequestRepository buildRequestRepository;

    @Mock
    private JenkinsProperties jenkinsProperties;

    // Use a real ObjectMapper for JSON parsing.
    private ObjectMapper objectMapper = new ObjectMapper();

    // The JenkinsClient instance under test (spied to allow overriding if needed later).
    private JenkinsClient jenkinsClient;

    @BeforeEach
    public void setUp() {
        // Create a spy instance so we can override non-helper methods later if required.
        jenkinsClient = Mockito.spy(new JenkinsClient(jenkinsProperties, objectMapper));
        // Inject dummy values for the @Value-injected fields.
        ReflectionTestUtils.setField(jenkinsClient, "jenkinsUrl", "http://dummy-jenkins/");
        ReflectionTestUtils.setField(jenkinsClient, "username", "dummyUser");
        ReflectionTestUtils.setField(jenkinsClient, "apiToken", "dummyToken");
        ReflectionTestUtils.setField(jenkinsClient, "expectedHost", "");
        // Inject the mocked BuildRequestRepository.
        jenkinsClient.buildRequestRepository = buildRequestRepository;
    }

    /**
     * Test helperStageStatus() when the key exists in the JSON node.
     */
    @Test
    public void testHelperStageStatus_keyPresent() throws Exception {
        String json = "{\"name\":\"Stage1\"}";
        JsonNode node = objectMapper.readTree(json);
        String result = jenkinsClient.helperStageStatus(node, "name");
        Assertions.assertEquals("Stage1", result, "helperStageStatus should return the value when the key exists");
    }

    /**
     * Test helperStageStatus() when the key is missing in the JSON node.
     */
    @Test
    public void testHelperStageStatus_keyMissing() throws Exception {
        String json = "{\"name\":\"Stage1\"}";
        JsonNode node = objectMapper.readTree(json);
        String result = jenkinsClient.helperStageStatus(node, "nonexistent");
        Assertions.assertEquals("", result, "helperStageStatus should return an empty string when the key is missing");
    }

    /**
     * Test helperDeployStatus() for a matching stage with a "SUCCESS" status.
     */
    @Test
    public void testHelperDeployStatus_withMatchingSuccess() throws Exception {
        // Create a JSON with a stages array that includes a stage "DevDeploy" having status "SUCCESS"
        String json = "{\n" +
                      "  \"stages\": [\n" +
                      "    {\"name\": \"DevDeploy\", \"status\": \"SUCCESS\"},\n" +
                      "    {\"name\": \"QADeploy\", \"status\": \"FAILED\"}\n" +
                      "  ]\n" +
                      "}";
        JsonNode node = objectMapper.readTree(json);
        String devDeployStatus = jenkinsClient.helperDeployStatus(node, "DevDeploy");
        Assertions.assertEquals("Y", devDeployStatus, "helperDeployStatus should return 'Y' when a matching stage with SUCCESS exists");
    }

    /**
     * Test helperDeployStatus() when no stage has a SUCCESS status.
     */
    @Test
    public void testHelperDeployStatus_noMatchingSuccess() throws Exception {
        // Create a JSON with stages where the matching stage does not have a "SUCCESS" status.
        String json = "{\n" +
                      "  \"stages\": [\n" +
                      "    {\"name\": \"DevDeploy\", \"status\": \"FAILED\"},\n" +
                      "    {\"name\": \"QADeploy\", \"status\": \"FAILED\"}\n" +
                      "  ]\n" +
                      "}";
        JsonNode node = objectMapper.readTree(json);
        String devDeployStatus = jenkinsClient.helperDeployStatus(node, "DevDeploy");
        Assertions.assertEquals("N", devDeployStatus, "helperDeployStatus should return 'N' when the matching stage does not have SUCCESS");
    }

    /**
     * Test helperDeployStatus() when the stages array is missing from the JSON.
     */
    @Test
    public void testHelperDeployStatus_noStages() throws Exception {
        String json = "{}";
        JsonNode node = objectMapper.readTree(json);
        String result = jenkinsClient.helperDeployStatus(node, "AnyStage");
        Assertions.assertEquals("N", result, "helperDeployStatus should return 'N' when there is no stages array");
    }

    /**
     * Test the validate() method returns true when required fields are present.
     */
    @Test
    public void testValidateMethod_returnsTrue() throws Exception {
        // Create a JSON node with required fields: number, displayName, and result.
        String json = "{\"number\": 1, \"displayName\": \"Build#1\", \"result\": \"SUCCESS\"}";
        JsonNode node = objectMapper.readTree(json);
        boolean valid = jenkinsClient.validate(node);
        Assertions.assertTrue(valid, "validate() should return true for a JSON node with all required fields");
    }

    /**
     * Test the validate() method returns false when one or more required fields are missing.
     */
    @Test
    public void testValidateMethod_returnsFalse() throws Exception {
        // Create a JSON node missing the "result" field.
        String json = "{\"number\": 1, \"displayName\": \"Build#1\"}";
        JsonNode node = objectMapper.readTree(json);
        boolean valid = jenkinsClient.validate(node);
        Assertions.assertFalse(valid, "validate() should return false for a JSON node missing required fields");
    }
}
