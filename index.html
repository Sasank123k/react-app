Below is the updated DagSqlServiceTest.java reflecting your service changes (using sourceSchema/sourceTableName for the Hive lookup and targetSchema + applicationName + tableName for the BigQuery name).

// File: src/test/java/com/wellsfargo/utcap/service/DagSqlServiceTest.java
package com.wellsfargo.utcap.service;

import com.wellsfargo.utcap.model.DagSql;
import com.wellsfargo.utcap.model.HiveTable;
import com.wellsfargo.utcap.model.JiraStoryIntake;
import com.wellsfargo.utcap.model.SqlDatatype;
import com.wellsfargo.utcap.repository.DagSqlRepository;
import com.wellsfargo.utcap.repository.HiveTableRepository;
import com.wellsfargo.utcap.repository.JiraStoryIntakeRepository;
import com.wellsfargo.utcap.repository.SqlDatatypeRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
public class DagSqlServiceTest {

    @Mock
    private DagSqlRepository dagSqlRepository;

    @Mock
    private JiraStoryIntakeRepository jiraStoryIntakeRepository;

    @Mock
    private HiveTableRepository hiveTableRepository;

    @Mock
    private SqlDatatypeRepository sqlDatatypeRepository;

    @InjectMocks
    private DagSqlService dagSqlService;

    private final String requirementId = "req123";

    @Test
    void testGetDagSql_existingRecord() {
        DagSql existing = new DagSql();
        existing.setRequirementId(requirementId);

        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.of(existing));

        DagSql result = dagSqlService.getDagSql(requirementId);

        assertSame(existing, result);
        verify(dagSqlRepository, times(1)).findByRequirementId(requirementId);
        verifyNoMoreInteractions(dagSqlRepository);
    }

    @Test
    void testGetDagSql_generateNewRecord() {
        // no existing record
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.empty());

        // JiraStoryIntake now uses sourceSchema/sourceTableName + targetSchema/tableName/applicationName
        JiraStoryIntake jiraStory = new JiraStoryIntake();
        jiraStory.setSourceSchema("srcSchema");
        jiraStory.setSourceTableName("srcTable");
        jiraStory.setTargetSchema("tgtSchema");
        jiraStory.setTableName("Tbl");
        jiraStory.setApplicationName("App");
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.of(jiraStory));

        // Hive lookup uses "srcSchema.srcTable"
        HiveTable hiveTable = new HiveTable();
        hiveTable.setFileSetAttr("col1|string|#col2|decimal(10,2)");
        when(hiveTableRepository.findByTableName("srcSchema.srcTable"))
            .thenReturn(Collections.singletonList(hiveTable));

        // type mapping
        Map<String,String> mapping = Map.of(
          "STRING","STRING",
          "DECIMAL","NUMERIC"
        );
        SqlDatatype sqlDatatype = new SqlDatatype("defaultMapping", mapping);
        when(sqlDatatypeRepository.findById("defaultMapping"))
            .thenReturn(Optional.of(sqlDatatype));

        // capture the saved entity
        when(dagSqlRepository.save(any(DagSql.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

        DagSql generated = dagSqlService.getDagSql(requirementId);

        // verify requirementId carried over
        assertEquals(requirementId, generated.getRequirementId());
        // BigQuery table name = "tgtSchema.AppTbl"
        assertTrue(generated.getCreateSqlContent()
                     .contains("CREATE TABLE tgtSchema.AppTbl"));
        assertTrue(generated.getDeleteSqlContent()
                     .contains("DROP TABLE tgtSchema.AppTbl"));

        verify(dagSqlRepository).save(generated);
    }

    @Test
    void testGenerateAndSaveDagSql_invalidFileSetAttr() {
        // Jira exists
        JiraStoryIntake jiraStory = new JiraStoryIntake();
        jiraStory.setSourceSchema("srcSchema");
        jiraStory.setSourceTableName("srcTable");
        jiraStory.setTargetSchema("tgtSchema");
        jiraStory.setTableName("Tbl");
        jiraStory.setApplicationName("App");
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.of(jiraStory));

        // odd tokens in fileSetAttr → error
        HiveTable hiveTable = new HiveTable();
        hiveTable.setFileSetAttr("col1|string|#col2");
        when(hiveTableRepository.findByTableName("srcSchema.srcTable"))
            .thenReturn(Collections.singletonList(hiveTable));

        RuntimeException ex = assertThrows(RuntimeException.class, () ->
            dagSqlService.generateAndSaveDagSql(requirementId)
        );
        assertTrue(ex.getMessage().contains("Invalid fileSetAttr format"));
    }

    @Test
    void testGenerateAndSaveDagSql_missingJiraStory() {
        when(jiraStoryIntakeRepository.findById(requirementId))
            .thenReturn(Optional.empty());

        RuntimeException ex = assertThrows(RuntimeException.class, () ->
            dagSqlService.generateAndSaveDagSql(requirementId)
        );
        assertTrue(ex.getMessage().contains("JiraStoryIntake not found"));
    }

    @Test
    void testUpdateDagSql_success() {
        DagSql existing = new DagSql();
        existing.setRequirementId(requirementId);
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.of(existing));

        when(dagSqlRepository.save(existing))
            .thenReturn(existing);

        DagSql result = dagSqlService.updateDagSql(requirementId, "newCreate", "newDelete");

        assertEquals("newCreate", result.getCreateSqlContent());
        assertEquals("newDelete", result.getDeleteSqlContent());
        verify(dagSqlRepository).save(existing);
    }

    @Test
    void testUpdateDagSql_missingRecord() {
        when(dagSqlRepository.findByRequirementId(requirementId))
            .thenReturn(Optional.empty());

        RuntimeException ex = assertThrows(RuntimeException.class, () ->
            dagSqlService.updateDagSql(requirementId, "c", "d")
        );
        assertTrue(ex.getMessage().contains("DagSql record not found"));
    }
}

What’s changed

We now stub and verify calls to jiraStoryIntakeRepository.findById(...) with the new getters/setters (sourceSchema, sourceTableName, targetSchema, tableName, applicationName).

The Hive lookup is asserted against "srcSchema.srcTable".

The generated BigQuery table name is now "tgtSchema.AppTbl".


Let me know if any other adjustments are needed!

