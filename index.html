import React, { useState, useEffect } from "react";
import PropTypes from "prop-types";
import JILEditor from "./JILEditor";
import JILNavigation from "./JILNavigation";
import { JILEditorProvider } from "./JILEditorContext";
import { MICROSERVICE_URL } from "../../../util/Constant";
import { generateSearHeader } from "../../../Authentication";
import { useAppGlobalState } from "@wf/react-library";
import { createDefaultJILFile, normalizeJobData } from "./JILUtils";
import "./JILEditor.css";

const JILEditorContainer = ({ requirementId, flow = "EDL" }) => {
  const [jilFiles, setJilFiles] = useState([]);
  const [metadata, setMetadata] = useState(null);
  const [loading, setLoading] = useState(true);
  const [currentFileIndex, setCurrentFileIndex] = useState(0);
  const globalState = useAppGlobalState();

  // Extracted file configuration without nested ternaries
  const fileConfig = flow === "INGRESS"
    ? { count: 2, names: ["INGRESS_JIL_1", "INGRESS_JIL_2"] }
    : { count: 1, names: ["EDL_JIL"] };

  useEffect(() => {
    fetch(`${MICROSERVICE_URL}/api/jilMetadata`, {
      method: "GET",
      headers: generateSearHeader(globalState),
    })
      .then((res) => res.json())
      .then((data) => {
        setMetadata(data[0].metaData);
      })
      .catch((err) => {
        console.error("Error fetching metadata:", err);
      });
  }, [globalState]);

  useEffect(() => {
    fetch(`${MICROSERVICE_URL}/api/jilData/${requirementId}`, {
      method: "GET",
      headers: generateSearHeader(globalState),
    })
      .then((res) => res.json())
      .then((data) => {
        let files = [];

        if (data.jilFiles && data.jilFiles.length > 0) {
          // Case 1: We have at least one jilFile
          files = data.jilFiles.map((file) => {
            if (
              metadata &&
              metadata.definitions &&
              file.jsonData &&
              file.jsonData.mainBox
            ) {
              // If there's metadata and we can normalize
              return {
                ...file,
                jsonData: {
                  ...file.jsonData,
                  mainBox: normalizeJobData(
                    file.jsonData.mainBox,
                    metadata.definitions.MainBOX,
                    metadata.definitions
                  ),
                },
              };
            }
            // Otherwise return the file as is
            return file;
          });
        } else if (metadata && metadata.definitions) {
          // Case 2: No jilFiles, but we have metadata definitions
          files = Array.from({ length: fileConfig.count }, () =>
            createDefaultJILFile(metadata.definitions)
          );
        } else {
          // Case 3: Neither jilFiles nor metadata definitions
          files = Array.from({ length: fileConfig.count }, () => ({
            jsonData: {},
          }));
        }

        setJilFiles(files);
        setLoading(false);
      })
      .catch((err) => {
        console.error("Error fetching JIL data:", err);
        setLoading(false);
      });
  }, [requirementId, globalState, metadata, fileConfig.count]);

  if (loading) {
    return <div>Loading...</div>;
  }

  const contextValue = {
    jilFiles,
    setJilFiles,
    currentFileIndex,
    setCurrentFileIndex,
    metadata,
    fileNames: fileConfig.names,
  };

  return (
    <JILEditorProvider value={contextValue}>
      <div className="jil-editor-container">
        <JILNavigation />
        <JILEditor requirementId={requirementId} />
      </div>
    </JILEditorProvider>
  );
};

JILEditorContainer.propTypes = {
  requirementId: PropTypes.string.isRequired,
  flow: PropTypes.string,
};

export default JILEditorContainer;
